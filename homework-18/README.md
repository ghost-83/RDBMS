# Домашнее задание

Спрогнозировать рост данных и спроектировать модель хранения и архивации.

## Цель

+ Научиться прогнозировать рост данных и возможные проблемы.

## Описание задание

+ Прогноз по возможному росту базы.
+ Пост данных.
+ Рост количества пользователей.
+ Всплески одновременных соединений.
+ Описываем возможные угрозы и методы защиты от них.
+ Предлагаем стратегии бэкапа.
+ Репликации.
+ Кластеризации.

## Реализация

### Описание проекта

Рассмотрим действующий проект по информированию клиентов, с интеграцией к разным поставщикам услуг оповещения. Информирование производится с помощью авто-обзвона и смс сообщений(они же в дальнейшем каналы информирования). Система в одном экземпляре, но обслуживает несколько регионов России. Списки на информирование ежемесячно поступают от подразделений регионов.  При реализации данного сервиса, были использованы 2 системы хранения данных, kafka и база данных. Мы рассмотрим работу БД.

### Прогноз по возможному росту базы

При старте проекта, списки содержали не более 30 000 клиентов в месяц. Так же, по скольку мы храним данные по каждому каналу(они нужны нам для отчета и актов на оплату) к данным по клиентам добавляется данные по звонку и данные по смс. За несколько лет работы количество данных в ежемесячных списках увеличилось до 1 500 000. По скольку количество клиентов растёт, а так же добавляются к уже имеющимся 10 регионам новые, система уже переделывается на нагрузку 2 000 000 клиентов в сутки и 10 000 000 в месяц. Предполагается что до данных показателей осталось менее 2 лет.

### Рост данных

Вся информация поступившая о клиентах, а так же данные по выполнению информирования имеют историческое значение и хранятся за весь период. Следовательно, рост будет очень большой. Плюс появились дополнительные номера клиентов для информирования и канал почта, что увеличило количество хранимой информации на 1 клиента в двое. На данный момент уже пересечена цифра хранимых данных в 100TB. Предполагается рост около 40TB в год.

### Рост количества пользователей

Пока системой пользуется только 1 подразделение организации, но планируется в ближайший год подключить еше одно. Для данного подразделения нужен всего 1 канал, а количество клиентов в списках не будет превышать 40 000 в месяц. Так же рос данных списков не ожидается, он стабилен уже несколько лет.

### Всплески одновременных соединений

По скольку списки на текущий месяц готовятся в этом же месяце, то 1-2 недели готовятся списки. После чего 1-1,5 недели длится информирование. В последнюю неделю подбивают данные в регионах согласно отчётам и планируют оплату. В связи с этим мы видим что основная нагрузка на систему приходится на 3 неделю месяца. По этому в новую систему и закладывается нагрузка 2 000 000 клиентов в сутки и 10 000 000 в месяц.

### Описываем возможные угрозы и методы защиты от них

Сама система находится в корпоративной сети, но у нее есть доступ к интернету для использования API поставщиков услуг оповещения. Система работает постоянно. Загрузкой списков занимается 1 человек. Это накладывает на нас обязанности по проведению мероприятий для обеспечения безопасности, и сохранности клиентских данных.

Базу данных храним в демилитаризованной зоне.

Требования по безопасности к системе БД, не зависящей от данных:

+ Работа в доверенной среде. Доверенная среда — инфраструктура предприятия с её защитными механизмами, обусловленными политикой безопасности.
+ Обеспечение физической безопасности файлов данных. Здесь требования не отличаются от тех, которые применимы к любым другим файлам приложений и пользователей.
+ Организация безопасной и актуальной настройки СУБД. К данному аспекту относятся такие общие вопросы обеспечения безопасности, как своевременная установка обновлений, отключение неиспользуемых модулей или применение эффективной политики паролей.

Требования к целостности информации для систем, зависящим от данных:

+ Безопасность пользовательского программного обеспечения. Речь идёт о задачах построения безопасных механизмов доступа и интерфейсов.
+ Безопасная организация работы с данными. Организация данных и управление ими — ключевой вопрос для системы хранения информации. Сюда входит и задача по организации данных с контролем целостности, и другие задачи, порой специфичные для СУБД.

Репликацию осуществляет пользователь с правами для репликации.

С данными будем работать также через специально созданных пользователей с реализованной системой прав только к тем объектам, которые необходимы для работы. Выносем средства аутентификации за пределы СУБД в промежуточное программное обеспечение и операционные системы.

Для выстраивания системы защиты информации требуется:

+ Выбор защищенного сервера или платформы баз данных, предлагающих собственные системы аудита и мониторинга.
+ Ограничение физического доступа к компьютерам, на которых находятся элементы БД, и ограничение прав доступа пользователей при помощи программных решений.
+ Использование двухслойных решений для организации доступа, при которых пользователь получает допуск к системе, содержащим только ссылки на элементы БД. Это минимизирует риск неправомерного использования, изменения или копирования информации.
+ Обеспечить наличие системы резервного копирования и восстановления базы после сбоев.
+ Исключение возможности запуска любых программ или процессов на сервере с БД.

Данный комплекс ограничений снизит риск неправомерного доступа к БД и позволит решить проблему безопасности информации.

### Предлагаем стратегии бэкапа, репликации, кластеризации

Для сервиса количество запросов на чтение и запись будут примерно ровно. Наличие kafka снизит большую часть нагрузки, но нагрузка все разно очень большая. В первую очередь это связано с объёмом вносимых данных в короткий период. Так же большую нагрузку будет нести сохранение промежуточных данных, для формирование ежесуточных отчетов. Ну и в итоге, конечный результат как мы помним увеличит объем внесенных данных почти что в 2 раза.

Для данной системы характерна "сезонность" и периодичность нагрузки. В это время система должна быть стабильно доступна для чтения и записи. Важно сохранять данные и поддерживать соединение во время сессии, чтобы не потерять данные.

Требуется система мониторинга нагрузки на базы данных: использование дисков, количество транзакций, нагрузка на процессов, блокировки в базе данных, длительные транзакции в БД, наличие/отсутствие свободных соединений.

#### Бэкапы

Так как основная нагрузка на базу предполагается в дневные часы(так как информирование проводится в период рабочего времени), обслуживание базы данных (VACUUM, бэкапирование и восстановление) будет проводится в ночное время. Бэкап можно снимать со слейвов.

Требуется разработать и утвердить соглашение о качестве сервиса (SLA), где будут обозначены правила и договорённости, касающиеся бэкапирования.

Для обеспечения сохранения и восстановления данных в случае сбоев требуется реализовать полноценную систему бэкапов:

+ Полное резервирование, раз в неделю.
+ Инкрементное раз в день.
+ Дифференциальное раз в час.

Время хранения бэкапов 90 дней.

Для хранения бэкапов должна быть реализованна стратегия «3–2–1». В соответствии с этой концепцией для сохранности данных нужно иметь три копии, которые будут храниться как минимум на двух типах носителей, а одна из копий должна размещаться на защищенном облачном хранилище в зашифрованном виде. Такой способ поможет предотвратить утрату данных в любых ситуациях.

#### Репликации и кластеризация

+ Требуется масштабирование нагрузки с помощью кластеризации. Используем PgBouncer для управления пулом соединений.
+ Требуется разработать и утвердить соглашение о качестве сервиса (SLA),  где будут обозначены правила и договорённости, касающиеся репликации.
+ Требуется настроить потоковую асинхронную репликацию, чтобы повысить отказоустойчивость и производительность.
+ Отчёты должны формироваться на реплики.
+ Требуется настроить автоматическое переключение серверов в случае отказа мастера.
